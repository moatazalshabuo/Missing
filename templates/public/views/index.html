{% extends "public/base.html" %}
{% load static %}
{% block style %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
crossorigin=""></script>
<style>
    input[type=date]{
        
        font-size: 13px;
        border-radius: 0px;
        border: 0px;
        border-bottom: 1px solid #5674ed;
        color: gray;
    }
    .form-check{
        margin-top: 10px;
    }
    .form-check label{
        font-size: 13px;
    }
    .marker-pin {
        width: 50px;
        height: 50px;
        border-radius: 50% 50% 50% 0;
        background-image: linear-gradient(105deg, #DFC54E 0%,#FFDB56 50%, #F9E8B0 100%);
        position: absolute;
        transform: rotate(-45deg);
        left: 50%;
        top: 50%;
        margin: -15px 0 0 -15px;
      }
      // to draw white circle
      .marker-pin::after {
          content: '';
          width: 24px;
          height: 24px;
          margin: 3px 0 0 3px;
          background: #fff;
          position: absolute;
          border-radius: 50%;
       }
      
      // to align icon
      .img_i{
         position: absolute;
         
         left: 0;
         right: 0;
         margin: 10px auto;
       
         z-index: 999;
         position: absolute;
         
         width: 60px;
         height: 60px;
         border-radius: 50%;
         
      }
</style>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
  .swal2-title{
    text-align: right;
  }
  li.list-group-item {
    font-size: 14px;
    text-align: right;
}

.filter1.active{
  background-image: linear-gradient(105deg, #DFC54E 0%,#FFDB56 50%, #F9E8B0 100%);
  color: #fff !important;
}
.filter1
{
font-size: 13px !important;
}
select{
  border-radius: 20px !important;
}
.filters{
  position: absolute;
  top: -55px;
  right: 0;
  width: 33%;
  z-index: 999;
  background-color: #fff;
  border-radius: 10px;
  padding: 10px;
  box-shadow: 1px 1px 3px;
}
label{
  color: #41464b;
}
</style>
{% endblock style %}

{% block content %}
<div class="main-banner wow fadeIn" id="top" data-wow-duration="1s" data-wow-delay="0.5s">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <div class="row">
          <div class="col-lg-6 align-self-center">
            <div class="left-content show-up header-text wow fadeInLeft" data-wow-duration="1s" data-wow-delay="1s">
              <div class="row">
                <div class="col-lg-12">
                  <h2 class="text-primary">نظام الاطفال المفقودين</h2>
                  <p>نظام يهدف إلى توثيق حالات الأشخاص المفقودين وتقديم وسائل للبحث عنهم واستعادتهم بأمان</p>
                </div>
                <div class="col-lg-12">
                  <div class="white-button first-button scroll-to-section">
                    <a href="{% url 'public.register_missing_person' %}">تقديم بلاغ <i class="fas fa-paste"></i></a>
                  </div>
                  <div class="white-button scroll-to-section">
                    <a href="#clients">عرض الخريطة <i class="fas fa-map"></i></a>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="right-image wow fadeInRight" data-wow-duration="1s" data-wow-delay="0.5s">
              <img src="{% static 'public/assets/images/slider-dec.png' %}" alt="">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!--  Start Map section -->
<div id="clients" class="the-clients">
  <div class="container-fluid">
    <div class="row">
      <div class="col-lg-12">
        <div class="section-heading mx-auto w-75">
          <h4>خريطة مواقع  <em>المفقودين</em></h4>
          <img src="assets/images/heading-line-dec.png" alt="">
          <p>
            تعرض هذه الخريطة المواقع الجغرافية التي تم فيها الإبلاغ عن حالات الأشخاص المفقودين، مما يساعد في توجيه جهود البحث والاستعادة.          </p>
        </div>
      </div>
      
      
      <div class="col-lg-12 px-0 mb-5" style="position: relative;">
        <div class="filters">
      
          <ul class="d-flex justify-content-between m-3"  role="tablist">
            <div class="border-button">
              <a class=" filter1 active" id="vertical-tab-0" data-val="0" data-bs-toggle="tab" href="#vertical-tabpanel-0" role="tab" aria-controls="vertical-tabpanel-0" aria-selected="true">الكل</a>
            </div>
            <div class="border-button">
                    <a class=" p-2 filter1" id="vertical-tab-1" data-val="1" data-bs-toggle="tab" href="#vertical-tabpanel-1" role="tab" aria-controls="vertical-tabpanel-1" aria-selected="false">المفقودين</a>
            </div>
            <div class="border-button">
                    <a class=" p-2 filter1" id="vertical-tab-2" data-val="2" data-bs-toggle="tab" href="#vertical-tabpanel-2" role="tab" aria-controls="vertical-tabpanel-2" aria-selected="false">المعثور عليهم</a>
            </div>
          </ul>
          <div class="form-group row m-3">
            <div class="col">
            <label for="from" style="font-size: 13px;">من</label>
            <input type="date" class="form-control m-2" id="from" />
            </div>
            <div class="col">
            <label for="to" style="font-size: 13px;">الى</label>
            <input type="date" class="form-control m-2" id="to" />
            </div>
          </div>
          <div class="form-group m-3" >
            <label style="font-size: 13px;">الفئة العمرية</label>
            <select class="form-select filter m-2" style="font-size: 13px;" name="ageRange" id="ageRange">
              <option value="">اختيار</option>
              <option value="0-6">اقل من 6 سنوات</option>
                      <option value="6-12">من عمر 12 - 6</option>
                      <option value="12-17">من عمر 12 - 17</option>
            </select>
          </div>
         
         
        </div>
        <div id="map" style="height: 500px;"></div>
      </div>
    </div>
  </div>
</div>
<!-- end Map section -->
<div id="services" class="services section">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 offset-lg-2">
        <div class="section-heading  wow fadeInDown animated" data-wow-duration="1s" data-wow-delay="0.5s" style="visibility: visible;-webkit-animation-duration: 1s; -moz-animation-duration: 1s; animation-duration: 1s;-webkit-animation-delay: 0.5s; -moz-animation-delay: 0.5s; animation-delay: 0.5s;">
          <h4>اخر <em>البلاغات</em> المضافة</h4>
          <img src="assets/images/heading-line-dec.png" alt="">
          <p>
            يقدم هذا القسم اخر بلاغات الفقدان في الموقع
          </p>
        </div>
      </div>
    </div>
  </div>
  <div class="container">
    <div class="row">
      {% for val in person %}
        <div class="col-lg-3">
          <div class="service-item first-service">
            <div class="icon" style="background-image: url({{ val.photo.url }});"></div>
            <h4>{{ val.first_name }} - {{ val.last_name }}</h4>
            <p>العمر : {{ val.get_birt_day }}</p>
            <p>اخر مرة شوهد فيها : {{ val.last_seen_date }}</p>
            <div class="text-button">
              <a href="{% url 'public.details' val.id %}">التفاصيل <i class="fa fa-arrow-right"></i></a>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endblock content %}

{% block script %}
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false" type="text/javascript"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.7.2/axios.min.js"></script>
<script>
    
    $(function(){
        var map = L.map('map').setView([32.89605782530956, 13.178557744256981], 11);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);
    var markers =[]
    function clean_marker(){
      markers.forEach(marker => map.removeLayer(marker));
      markers = [];
     }
    
   function get_missing(){
    var filter1 = $('.filter1.active').data('val')
    var from_date = $('#from').val()
    var to_date = $('#to').val()
    var curage = $('#ageRange').val()
    
    clean_marker()
    axios.get('/api/get_missing',{params:{status:filter1,ourage:curage == undefined?-1:curage,from:from_date,to:to_date}}).then((res)=>{
      var data = res.data.person
      for(let i of data){
          var icon = L.divIcon({
              id:i.id,
              className: 'custom-div-icon',
              html: `<div style='background-color:#D70040;' class='marker-pin'></div><img style='
                  position: absolute;
                  left: 5px;
                  margin: 10px auto;
                  z-index: 999;
                  position: absolute;
                  width: 40px;
                  height: 40px;
                  border-radius: 50%;
                      box-shadow: 1px 2px 8px #323232;
       ' src='${i.photo}'>`,
              iconSize: [30, 42],
              iconAnchor: [15, 42]
          });
          
          var marke = L.marker([i.lat, i.lng], { icon: icon ,}).addTo(map).on('click',(e)=>{
              var id = e.sourceTarget.options.icon.options.id

              axios.get(`/api/person-data/${id}`).then((res)=>{
                var person_data = res.data
                var bith_day = new Date(person_data.birth_date)
              var year = Math.floor(Math.abs(Date.now() - bith_day.getDate() ) / 1000 * 60 * 60 * 24 * 360)
              console.log(Date.now(),bith_day.getDate() / 60 * 60 * 24 * 360 )
                Swal.fire({
                  title: `الاسم : ${person_data.first_name} ${person_data.last_name}`,
                  html: `
                        <ul class="list-group list-group-flush">
                          <li class="list-group-item">الجنس : ${person_data.get_gender}</li>
                          <li class="list-group-item">العمر : ${person_data.get_birt_day} </li>
                          <li class="list-group-item">اخر مرة شوهد فيها : ${person_data.last_seen_date} </li>
                          <li class="list-group-item">الحالة : ${ person_data.get_status }</li>
                        </ul>
                        `,
                        confirmButtonText:'اغلاق',
                        confirmButtonColor:'#D70040',
                        showDenyButton: true,
                        denyButtonText:'عرض التفاصيل',
                        denyButtonColor:'#091e42'
                }).then((result)=>{
                  if(result.isDenied){
                    location.replace('/details/'+id)
                  }
                });
              })
          });
          markers.push(marke)
      }
  })
   }
   get_missing()
   $('.filter1').click(function(){
    $('.filter1').removeClass('active')
    $(this).addClass('active')
    get_missing()
  })
   $('#ageRange , #from ,#to').change(()=>get_missing())
    })
</script>
{% endblock script %}
